#!/usr/bin/env expect
#
# Copyright (c) 2021-2022, Arm Limited.
#
# SPDX-License-Identifier: MIT

set guest_vm_name [lindex "${argv}" 0]
set cmd [lindex "${argv}" 1]
set login_prompt "${guest_vm_name} login:"
set username "$env(USER)"
set prompt "${username}@${guest_vm_name}:"
set clean_console "\025\010\r"
set timeout 60
if {$argc == 3} {
    set timeout [lindex "${argv}" 2]
}
puts "Setting timeout to '${timeout}' seconds."

source "guest-vm-funcs.expect"

# Default timeout handler logs that a time out occured, but allows the script
# to continue. This may be overriden by adding a timeout handler to a particular
# expect.
expect_after {
    timeout { puts "Expect script timed out after $timeout seconds."; }
}

set rc [guest_vm_logon "${guest_vm_name}"]
if { $rc != 0 } {
    puts "Failed to log-in to '${guest_vm_name}'"
    exit ${rc}
}

set rc [run_cmd "${cmd}"]
if { $rc != 0 } {
    puts "Failed to run '${cmd}' on '${guest_vm_name}'"
    exit ${rc}
}

set rc [guest_vm_logoff]
if { $rc != 0 } {
    puts "Failed to log-off from '${guest_vm_name}'"
    exit ${rc}
}

puts "Success"
exit 0
